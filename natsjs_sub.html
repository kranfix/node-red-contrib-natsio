<!-- see: https://docs.nats.io/nats-concepts/jetstream/consumers -->

<script type="text/javascript">

  function emptyOrNumber(v) {
    return !v || RED.validators.number()(v)
  }

  RED.nodes.registerType('natsjs-sub', {
    category: 'NATS',
    color: '#3FADB5',
    defaults: {
      name: { value:""},
      server: { value: "", type: "natsio-server", required: true },
      stream: { value: "" },
      durable: { value: "" },
      deliverySubject: { value: "_INBOX." +  (Date.now() * 1000000 + Math.random()).toString(16).slice(2), required: true },
      filterSubject: { value: "", required: true  },
      maxWanted: { value: "",required: false,   validate:  emptyOrNumber  }, // unsubscribe after maxWanted,
      maxAckPending: { value: "-1", validate: emptyOrNumber },
      durable: { value: "" },
      deliverPolicy: { value: "all", required: true },
      ackPolicy: { value: "none", required: true },
      replayPolicy: { value: "instant", required: true },
      ackWait: { value: "", validate: emptyOrNumber  },
      flowControl: { value: false },
      idleHeartbeat: { value: false },
      maxDeliver: { value: "", required: false, validate: emptyOrNumber  },
      rateLimit: { value: "",required: false,  validate: emptyOrNumber  },
      sampleFrequency: { value: "", required: false, validate: emptyOrNumber },
    },
    inputs: 0,
    outputs: 1,
    icon: "fa-space-shuttle.svg",
    label: function () {
      return this.name || ("natsjs-sub: " + this.stream +  ( this.filterSubject ? " ("+ this.filterSubject+ ")"  : "") );
    }

  });
</script>

<script type="text/x-red" data-template-name="natsjs-sub">
  <div class="form-row">
    <label for="node-input-server"><i class="icon-tag"></i> server</label>
    <input type="text" id="node-input-server" placeholder="server">
  </div>
  <div class="form-row">
    <label for="node-input-stream"><i class="icon-tag"></i> stream</label>
    <input type="text" id="node-input-stream" placeholder="stream">
  </div>

  <div class="form-row">
    <label for="node-input-durable"><i class="icon-tag"></i> durable name</label>
    <input type="text" id="node-input-durable" placeholder="durable">
  </div>


  <div class="form-row">
    <label for="node-input-filterSubject"><i class="icon-tag"></i> FilterSubject</label>
    <input type="text" id="node-input-filterSubject" placeholder="filterSubject">
  </div>
  <div class="form-row">
    <label for="node-input-deliverySubject"><i class="icon-tag"></i> DeliverySubject</label>
    <input type="text" id="node-input-deliverySubject" placeholder="deliverySubject">
  </div>
  <div class="form-row">
    <label for="node-input-maxWanted">
      <i class="icon-tag"></i> Unsubscribe after
    </label>
    <input type="text" id="node-input-maxWanted" placeholder="infinite by default">
  </div>

  <div class="form-row">
    <label for="node-input-deliverPolicy">
      <i class="icon-tag"></i> DeliverPolicy
    </label>
    <select type="text" id="node-input-deliverPolicy" style="width: 150px;">
      <option value="all">DeliverAll</option>
      <option value="last">DeliverLast</option>
      <option value="last_per_subject">DeliverLastPerSubject</option>
      <option value="new">DeliverNew</option>
    </select>
    </div>


    <div class="form-row">
      <label for="node-input-ackPolicy">
        <i class="icon-tag"></i> ackPolicy
      </label>
      <select type="text" id="node-input-ackPolicy" style="width: 150px;">
        <option value="none">AckNone</option>
        <option value="explicit">AckExplicit</option>
        <option value="all">AckAll</option>
      </select>
      </div>
      <div class="form-row">
        <label for="node-input-replayPolicy">
          <i class="icon-tag"></i> replayPolicy
        </label>
        <select type="text" id="node-input-replayPolicy" style="width: 150px;">
          <option value="instant">ReplayInstant</option>
          <option value="original">ReplayOriginal</option>
        </select>
        </div>
    
    <div class="form-row">
      <label for="node-input-maxAckPending">
        <i class="icon-tag"></i> max Ack Pending
      </label>
      <input type="text" id="node-input-maxAckPending" placeholder="infinite by default">
    </div>
    <div class="form-row">
      <label for="node-input-flowControl">
        <i class="icon-bookmark"></i> FlowControl
      </label>
      <input type="checkbox" id="node-input-flowControl">
    </div>
    <div class="form-row">
      <label for="node-input-idleHeartbeat">
        <i class="icon-bookmark"></i> IdleHeartbeat
      </label>
      <input type="checkbox" id="node-input-idleHeartbeat">
    </div>

    
    <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
      <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
  </div>


</script>

<script type="text/x-red" data-help-name="natsjs-sub">
  <p>jetstream-sub node</p>
</script>